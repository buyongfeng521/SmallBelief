@using Webdiyer.WebControls.Mvc;
@model PagedList<Model.t_user>

@{
    ViewBag.Title = "UserList";
    Layout = "~/Views/_Layout.cshtml";
}

<!--head-->
<div class="row">
    <div class="col-lg-12">
        <h3 class="page-header">会员列表</h3>
    </div>
</div>

<!--content-->
<div class="row">
    <div class="col-lg-12">
        @using (Html.BeginForm("UserList", "User", FormMethod.Get, new { @class = "form-inline" }))
        {
            <div class="form-group">
                <label class="sr-only">keywords</label>
                <input type="text" class="form-control" id="keywords" name="keywords" placeholder="关键字" value="@ViewBag.Keywords" maxlength="20">
            </div>
            <button class="btn btn-default">搜索</button>
        }
        <hr />
        <div class="dataTable_wrapper">
            <table class="table table-bordered table-hover">
                <tr>
                    <th>编号</th>
                    <th>会员名称</th>
                    <th>手机号码</th>
                    <th>注册时间</th>
                    <th>操作</th>
                </tr>
                @{
                    int i = 0;
                    foreach(var item in Model)
                    {
                        i++;
                        <tr>
                            <td>@i</td>
                            <td>@item.user_name</td>
                            <td>@item.user_phone</td>
                            <td>@item.create_time</td>
                            <td>
                                <a href="javascript:" onclick="viewUser(@item.ID)">查看</a>
                                &nbsp;&nbsp;
                                <a href="javascript:" class="text-success" onclick="applyCoupon(@item.ID,@item.user_phone)">分配优惠卷</a>
                                @*&nbsp;&nbsp;
                                <a href="javascript:" class="text-info">查看优惠卷</a>*@
                            </td>
                        </tr>
                    }
                }
            </table>

            <div class="text-center">
                <nav>
                    @Html.Pager(Model, new PagerOptions
                    {
                        PageIndexParameterName = "index",
                        ContainerTagName = "ul",
                        CssClass = "pagination",

                        CurrentPagerItemWrapperFormatString = "<li class=\"active\"><a href=\"javascript:form.submit();\">{0}</a></li>",
                        PagerItemWrapperFormatString = "<li>{0}</li>",
                        Id = "bootstrappager"
                    })
                </nav>
            </div>

        </div>
    </div>
</div>

<!--Modal-->
<!-- ViewUser -->
<div class="modal fade" id="modalUserInfo">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">会员信息</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">用户名：</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="pUserName">小菜</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">手机号码：</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="pUserPhone">18601352457</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">注册时间：</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="pCreateTime">2016-06-15</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">最后登录时间：</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="pLastLoginTime">2016-06-15</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Aplly Coupon-->
<div class="modal fade" id="modalApplyCoupon">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">分配优惠卷</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="frmApplyCoupon">
                    <div class="form-group">
                        @Html.Hidden("hideUserID")
                        <label class="col-sm-3 control-label">会员手机号：</label>
                        <div class="col-sm-9">
                            <p class="form-control-static" id="user_phone"></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputPassword" class="col-sm-3 control-label">优惠卷：</label>
                        <div class="col-sm-9">
                            @*<input type="password" class="form-control" id="inputPassword" placeholder="Password">*@
                            @Html.DropDownList("ddlCouponID", ViewBag.CouponSelList as IEnumerable<SelectListItem>, new { @class="form-control"})
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="applyCouponSave()">确定</button>
            </div>
        </div>
    </div>
</div>

<script>
    function viewUser(id){
        if(id){
            var url = "/User/GetUserBy?id=" + id;
            $.get(url,function(data){
                if(data){
                    $("#pUserName").text(data.user_name);
                    $("#pUserPhone").text(data.user_phone);
                    $("#pCreateTime").text(data.create_time);
                    $("#pLastLoginTime").text(data.last_login_time);
                    $("#modalUserInfo").modal("show");
                }
            });
        }
    }
</script>


<script>
    function applyCoupon(user_id,user_phone) {
        if (user_id) {
            $("#hideUserID").val(user_id);
            $("#user_phone").html(user_phone);
            $("#modalApplyCoupon").modal("show");
        }
    }

    function applyCouponSave() {
        $.post("/User/ApplyCoupon", $("#frmApplyCoupon").serialize(), function (data) {
            $.procAjaxData(data, function () {
                location.href = window.location.href;
            });
        });
    }

</script>


